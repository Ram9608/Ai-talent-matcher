<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Talent Matcher - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary { border-radius: 8px; padding: 10px 20px; font-weight: 600; }
        .badge-score { font-size: 0.9rem; padding: 6px 12px; }
        .feedback-small { font-size: 0.85rem; color: #555; font-style: italic; }
    </style>
</head>
<body>

<div class="container py-5">
    <h2 class="text-center mb-4">ðŸš€ AI Talent Matcher Dashboard</h2>

    <div class="card main-card p-4 mb-5">
        <h4 class="mb-3 text-primary">Upload & Analyze Resume</h4>
        <form id="uploadForm">
            <div class="mb-3">
                <label class="form-label fw-bold">Job Description</label>
                <textarea class="form-control" id="jobDesc" rows="4" placeholder="Paste the job requirements here..." required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Resume (PDF only)</label>
                <input type="file" class="form-control" id="resumeFile" accept=".pdf" required>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Analyze & Rank Candidate</button>
        </form>
    </div>

    <div class="card main-card p-4">
        <h4 class="mb-3 text-success">Ranked Candidates (DSA Sorted)</h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle mt-2">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Resume Name</th>
                        <th>Match Score</th>
                        <th>AI Hiring Feedback</th>
                    </tr>
                </thead>
                <tbody id="rankingsTable">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Function to load rankings from the SQL Database
    async function loadRankings() {
        try {
            const response = await fetch('/rankings/');
            const data = await response.json();
            const tableBody = document.getElementById('rankingsTable');
            
            // Mapping the database data to table rows
            tableBody.innerHTML = data.rankings.map(candidate => `
                <tr>
                    <td><strong>#${candidate.id}</strong></td>
                    <td>${candidate.filename}</td>
                    <td>
                        <span class="badge badge-score ${candidate.match_score >= 70 ? 'bg-success' : 'bg-warning text-dark'}">
                            ${candidate.match_score}%
                        </span>
                    </td>
                    <td class="feedback-small">${candidate.feedback || 'Analyzing...'}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error("Error fetching rankings:", error);
        }
    }

    // Handle Form Submission
    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerText = "AI is Analyzing... Please Wait";

        const formData = new FormData();
        formData.append('job_description', document.getElementById('jobDesc').value);
        formData.append('file', document.getElementById('resumeFile').files[0]);

        try {
            const response = await fetch('/upload/', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Analysis Successful!');
                loadRankings(); // Refresh the table automatically
            } else {
                alert('Something went wrong during analysis.');
            }
        } catch (error) {
            alert('Connection Error!');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "Analyze & Rank Candidate";
            document.getElementById('uploadForm').reset();
        }
    };

    // Initial load when page opens
    loadRankings();
</script>

</body>
</html>